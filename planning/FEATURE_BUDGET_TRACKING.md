# Feature: Budget Tracking & Budgeting
## Product Request from Robert-Jan Sips (Product Owner)

**Date:** 2026-02-05  
**Status:** Requirements Definition & Prioritization  

---

## 1. PHASE 1: TOKEN TRACKING REQUIREMENTS

### 1.1 Data to Track

**Core Metrics (MVP):**
- **Tokens Input:** Tokens sent to LLM per request
- **Tokens Output:** Tokens generated by LLM per response
- **Cost per Request:** Calculated based on model pricing (GPT-4, Claude, etc.)
- **Agent ID:** Which agent made the request
- **Session ID:** Group requests by user session (for historical trends)
- **Model Used:** Track which LLM model was called
- **Timestamp:** When the request occurred

**Extended Metrics (Phase 2):**
- Cost per agent (aggregate)
- Cost per session
- Cost per user
- Token efficiency ratio (output/input)
- Daily/weekly/monthly summaries

### 1.2 Display Options

**MVP (Phase 1):**
- **Agent Detail View:** Show current & cumulative token usage in agent card
  - Display: "Tokens this session: 4,234 | Cost: $0.12"
  - Trend indicator: Cost per request over time
  - Cost: Low effort, high value

**Recommended Future (Phase 2):**
- Dashboard widget: Total spend across all agents (real-time)
- Detailed budget dashboard: Charts, trends, projections
- Per-agent cost breakdown table

### 1.3 Storage Architecture

**Recommended: Hybrid approach**

| Storage | Use Case | Why |
|---------|----------|-----|
| **In-Memory (Redis/RAM)** | Current session token counts | Fast real-time updates, simple display |
| **Database (PostgreSQL)** | Historical data, analytics | Persistent, queryable, supports trending |
| **Log Files** | Audit trail & raw events | Immutable record for compliance |

**Implementation Flow:**
1. Every LLM call → log event to both in-memory + database
2. In-memory cache maintains "last 30 days" for dashboard
3. Database stores unlimited history for reports & trending

### 1.4 Granularity & Display Frequency

| Granularity | Frequency | Display | Use Case |
|------------|-----------|---------|----------|
| **Per Request** | Real-time | Log entries, developer view | Debugging, cost anomalies |
| **Per Session** | Real-time | Agent detail view, session summary | User awareness, session costs |
| **Hourly** | Batch/hourly | Agent dashboard widget | Quick pulse check |
| **Daily** | Daily digest | Optional email/notification | Budget tracking, trends |
| **Historical** | On-demand | Budget analytics dashboard | Planning, forecasting |

**MVP Start:** Per-session + hourly summaries (simplest to implement)

---

## 2. PRIORITIZATION RECOMMENDATION

### Current State:
- **Priority #1:** Agent Control Actions UI (stop/restart/message buttons)
- **New Request:** Budget Tracking & Budgeting (token tracking phase)

### Recommendation: **BUILD BUDGET TRACKING FIRST** ⭐

#### Reasoning:

| Factor | Analysis |
|--------|----------|
| **Dependency Risk** | Budget tracking can be added independently; Control Actions doesn't block it |
| **Business Value** | Token/cost visibility is critical NOW (prevents runaway spending) vs. Control Actions is operational convenience |
| **Implementation Effort** | Token tracking Phase 1 = **2-3 days** (straightforward instrumentation + UI) |
| **Control Actions Effort** | UI buttons + backend hooks = **3-4 days** |
| **User Need Urgency** | **High (Budget):** As agents proliferate, cost visibility becomes critical. Blind spots = surprise bills **Medium (Control):** Nice-to-have for ops, not a blocker |
| **Foundation Building** | Token tracking creates infrastructure for future billing, budgeting, and alerting; Control Actions is more isolated |
| **Cost Risk Mitigation** | Without token tracking, nobody notices if a broken loop burns through tokens → **financial risk** |

#### Hybrid Approach (Best of Both):
1. **Week 1:** Budget Tracking Phase 1 (token logging + agent detail view) — **2-3 days**
2. **Week 1:** Control Actions UI (lightweight implementation) — **parallel, 2 days**
3. **Week 2+:** Expand both (advanced budget dashboard, agent management features)

**If sequencing is required:** Budget Tracking Phase 1 first.

---

## 3. USER STORIES FOR PRIORITY #1: BUDGET TRACKING PHASE 1

### Story 1: Agent-Level Token Tracking (MVP)
```
TITLE: View Current Session Token Usage per Agent

AS A: System administrator or agent operator
I WANT TO: See real-time token consumption for each agent in the current session
SO THAT: I can monitor LLM costs and detect runaway token consumption early

ACCEPTANCE CRITERIA:
✓ Each agent card/detail view shows: "Tokens: 4,234 | Cost: $0.12"
✓ Token counts update in real-time as the agent makes LLM calls
✓ Cost is calculated based on the model used (GPT-4, Claude, etc.)
✓ Display includes timestamp of last request
✓ Cost is color-coded: green (<$1), yellow ($1-5), red (>$5) for session

TASKS:
- [ ] Create token tracking middleware in agent request pipeline
- [ ] Add model pricing config (GPT-4, Claude, etc.)
- [ ] Update agent detail/card component to display tokens + cost
- [ ] Add real-time counter update via websocket/polling
- [ ] Write unit tests for token calculation

EFFORT: 2 days
PRIORITY: P0 (MVP)
```

### Story 2: Session Token Summary & Storage
```
TITLE: Persist and Display Session-Level Token Summary

AS A: Product manager or billing analyst
I WANT TO: See total token usage and cost for each completed session
SO THAT: I can track spending trends and plan for budget allocation

ACCEPTANCE CRITERIA:
✓ Session end → save total tokens (in/out), total cost, per-agent breakdown
✓ New "Session History" tab shows: [Session ID | Start | End | Tokens | Cost | Agents]
✓ Data persists to database (PostgreSQL)
✓ Can view last 30 sessions' history
✓ Cost totals are queryable and exportable (CSV)

TASKS:
- [ ] Create Session tracking model (PostgreSQL)
- [ ] Add session event capture (on session end)
- [ ] Build Session History UI view
- [ ] Add database queries for trend analysis
- [ ] Write integration tests

EFFORT: 2 days
PRIORITY: P0 (MVP)
```

### Story 3: Agent Cost Trend Indicator
```
TITLE: Show Cost Trending for Each Agent (Session View)

AS A: Agent developer or operator
I WANT TO: See if an agent's per-request cost is trending up or down
SO THAT: I can detect inefficiencies early (e.g., larger prompts, more verbose responses)

ACCEPTANCE CRITERIA:
✓ Agent detail view shows: "Cost/Request: $0.008 ↗️" (with trend arrow)
✓ Trend calculated from last 10 requests in session
✓ Up arrow (↗️) if cost is increasing, down (↘️) if decreasing, stable (→) if flat
✓ Hover tooltip shows: "Avg cost/request: $0.008 (last 10 requests)"
✓ Visual indicator (color) for high cost agents (>$0.05/request)

TASKS:
- [ ] Add request cost tracking to in-memory cache
- [ ] Implement trend calculation (sliding window last 10 requests)
- [ ] Update UI component with trend indicator
- [ ] Add styling for cost levels (normal/warning/high)
- [ ] Add tooltip with breakdown

EFFORT: 1 day
PRIORITY: P1 (Nice-to-have for MVP, add if time permits)
```

### Story 4: Admin Token Budget Configuration
```
TITLE: Set Spending Alerts for Agents

AS A: System administrator
I WANT TO: Set a spending cap or alert threshold per agent
SO THAT: I'm notified if a session starts burning tokens unexpectedly

ACCEPTANCE CRITERIA:
✓ New "Budget Settings" admin panel section
✓ Can set: Alert threshold per session (e.g., $10) and per agent (e.g., $5)
✓ Alert UI shows in-app notification when threshold exceeded
✓ Notification includes: Agent name, current spend, threshold
✓ Admin can auto-pause agent if threshold exceeded (Phase 2)

TASKS:
- [ ] Create BudgetConfig model (database)
- [ ] Build admin settings UI for thresholds
- [ ] Add alert check on every token log
- [ ] Implement in-app notification system
- [ ] Write tests for alert triggering

EFFORT: 2 days
PRIORITY: P1 (Phase 1 stretch goal or Phase 2)
```

---

## 4. IMPLEMENTATION ROADMAP

### Phase 1 (Week 1-2): Token Tracking Foundation
**Must-Have:**
- Story 1: Real-time token display per agent ✓
- Story 2: Session summary & storage ✓

**Nice-to-Have (if time):**
- Story 3: Cost trend indicator
- Story 4: Alert thresholds (basic)

**Deliverable:** Agents show live token/cost; sessions tracked in database

### Phase 2 (Week 3+): Analytics & Budgeting
- Budget dashboard (charts, trends)
- Historical analytics queries
- Budget forecasting
- Alerting & auto-pause
- Cost per agent/user rollups

### Phase 3: Advanced Features
- Budget allocation per team
- Cost chargeback reports
- ML-based cost anomaly detection

---

## 5. TECHNICAL NOTES

### Token Pricing Matrix (Example)
```json
{
  "gpt-4": { "input": 0.00003, "output": 0.00006 },
  "gpt-4-turbo": { "input": 0.00001, "output": 0.00003 },
  "claude-3-opus": { "input": 0.000015, "output": 0.00075 },
  "claude-3-sonnet": { "input": 0.000003, "output": 0.000015 }
}
```

### Storage Strategy
- **Redis:** Current session counters (volatile, fast)
- **PostgreSQL:** Session/agent history (persistent)
- **Logs:** Raw token events (audit)

### Real-Time Updates
- WebSocket or polling (agent detail view)
- Every request → update in-memory cache → broadcast to UI
- Batch → database every 5 minutes (avoid write overhead)

---

## 6. RISKS & MITIGATIONS

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|-----------|
| Model pricing changes | Low | Medium | Externalize to config; version pricing |
| Database query slowness | Low | High | Index session_id, agent_id; use caching |
| Runaway token logging | Medium | High | Cap log retention; batch writes; archival |
| Floating-point precision errors | Low | Low | Store as cents (integers); round carefully |

---

## NEXT STEPS

1. **Review & Approve** this plan (Robert-Jan & team)
2. **Assign developers** to Phase 1 stories
3. **Create database schema** (Session, TokenEvent, BudgetConfig tables)
4. **Implement Story 1** (real-time display) in parallel with Stories 2 & 3
5. **QA & Deploy** within 1 week

---

**Estimated Total Effort:** 4-5 days (Phase 1 MVP)  
**Estimated ROI:** Very High (cost visibility + risk mitigation)
